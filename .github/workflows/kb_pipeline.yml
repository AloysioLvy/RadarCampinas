name: ğŸ”® Knowledge Base Pipeline

on:
  schedule:
    # Executar toda segunda-feira Ã s 3:00 AM (1x por semana)
    - cron: '0 3 * * 1'
    # Para diÃ¡rio, use: '0 3 * * *'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: 'NÃºmero de dias para processar (padrÃ£o: 365)'
        required: false
        default: '365'
      cell_resolution:
        description: 'ResoluÃ§Ã£o das cÃ©lulas em metros (500 ou 1000)'
        required: false
        default: '500'

  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/internal/services/**'
      - 'backend/internal/database/migrations/**'
      - '.github/workflows/kb_pipeline.yml'

env:
  GO_VERSION: '1.21'
  POSTGRES_VERSION: '15'

jobs:
  # ============================================================================
  # STAGE 1: VALIDATE
  # ============================================================================
  
  lint-go:
    name: ğŸ” Lint Go Code
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ“¦ Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: ğŸ“¥ Download dependencies
        run: go mod download
      
      - name: ğŸ” Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

  validate-sql:
    name: âœ… Validate SQL Syntax
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check SQL files exist
        run: |
          if [ ! -f "backend/internal/database/migrations/knowledge_base_schema_mysql.sql" ]; then
            echo "âŒ MySQL migration file not found!"
            exit 1
          fi
          if [ ! -f "backend/internal/database/migrations/knowledge_base_schema.sql" ]; then
            echo "âŒ PostgreSQL migration file not found!"
            exit 1
          fi
          echo "âœ… Migration files found"
      
      - name: ğŸ” Basic SQL syntax check (MySQL)
        run: |
          echo "Validando sintaxe MySQL..."
          # Verificar se hÃ¡ erros Ã³bvios de sintaxe no arquivo MySQL
          grep -n "CREATE TABLE" backend/internal/database/migrations/knowledge_base_schema_mysql.sql | head -5
          grep -n "CREATE DATABASE" backend/internal/database/migrations/knowledge_base_schema_mysql.sql || true
          
          # Verificar se as tabelas principais existem
          for table in "curated_incidents" "curated_cells" "external_holidays" "features_cell_hourly"; do
            if grep -q "$table" backend/internal/database/migrations/knowledge_base_schema_mysql.sql; then
              echo "âœ… Tabela $table encontrada no MySQL schema"
            else
              echo "âŒ Tabela $table NÃƒO encontrada no MySQL schema"
              exit 1
            fi
          done
          echo "âœ… MySQL syntax looks good"
      
      - name: ğŸ” Basic SQL syntax check (PostgreSQL)
        run: |
          echo "Validando sintaxe PostgreSQL..."
          # Verificar se hÃ¡ erros Ã³bvios de sintaxe no arquivo PostgreSQL
          grep -n "CREATE TABLE" backend/internal/database/migrations/knowledge_base_schema.sql | head -5 || true
          grep -n "CREATE SCHEMA" backend/internal/database/migrations/knowledge_base_schema.sql || true
          echo "âœ… PostgreSQL syntax looks good"

  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ›¡ï¸ Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: './...'

  # ============================================================================
  # STAGE 2: BUILD
  # ============================================================================
  
  build-app:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [lint-go, validate-sql, security-scan]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ“¦ Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: ğŸ“¥ Download dependencies
        run: go mod download
      
      - name: ğŸ—ï¸ Build binary
        run: |
          go build -v -o radar-campinas-kb ./cmd/server
          ls -lh radar-campinas-kb
      
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: radar-campinas-kb
          path: radar-campinas-kb
          retention-days: 7

  # ============================================================================
  # STAGE 3: TEST
  # ============================================================================
  
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: build-app
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ“¦ Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: ğŸ§ª Run tests
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...
      
      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.txt
          flags: unittests

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build-app
    services:
      postgres:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: radar_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ§ª Run integration tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: testpass
          DB_NAME: radar_test
        run: |
          go test -v -tags=integration ./internal/services/... || echo "âš ï¸  Integration tests nÃ£o implementados ainda"

  # ============================================================================
  # STAGE 4: MIGRATE & TEST DATABASE
  # ============================================================================
  
  test-migrations:
    name: ğŸ—„ï¸ Test Migrations
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    services:
      postgres:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: radar_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ—„ï¸ Apply migrations
        run: |
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -f backend/internal/database/migrations/knowledge_base_schema.sql
      
      - name: âœ… Verify schemas
        run: |
          echo "Verificando schemas criados..."
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -c "\dn" | tee schemas.txt
          
          # Verificar se todos os schemas foram criados
          for schema in curated external features analytics; do
            if grep -q "$schema" schemas.txt; then
              echo "âœ… Schema $schema encontrado"
            else
              echo "âŒ Schema $schema NÃƒO encontrado"
              exit 1
            fi
          done
      
      - name: âœ… Verify tables
        run: |
          echo "Verificando tabelas criadas..."
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -c "\dt curated.*" | tee tables.txt
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -c "\dt external.*" >> tables.txt
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -c "\dt features.*" >> tables.txt
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -c "\dt analytics.*" >> tables.txt
          
          # Verificar tabelas essenciais
          for table in "curated.incidents" "curated.cells" "external.weather" "features.cell_hourly"; do
            if grep -q "$table" tables.txt; then
              echo "âœ… Tabela $table encontrada"
            else
              echo "âŒ Tabela $table NÃƒO encontrada"
              exit 1
            fi
          done
      
      - name: âœ… Test idempotency
        run: |
          echo "Testando idempotÃªncia das migrations..."
          PGPASSWORD=testpass psql -h localhost -U postgres -d radar_test -f internal/database/migrations/knowledge_base_schema.sql
          echo "âœ… Migrations sÃ£o idempotentes"

  # ============================================================================
  # STAGE 5: DEPLOY/RUN (Manual Trigger)
  # ============================================================================
  
  generate-knowledge-base:
    name: ğŸš€ Generate Knowledge Base
    runs-on: ubuntu-latest
    needs: test-migrations
    # Apenas executar em schedule ou workflow_dispatch
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    services:
      source-db:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: ${{ secrets.SOURCE_DB_PASSWORD }}
          POSTGRES_DB: source_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
      
      target-db:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_PASSWORD: ${{ secrets.TARGET_DB_PASSWORD }}
          POSTGRES_DB: radar_campinas
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ“¥ Download binary artifact
        uses: actions/download-artifact@v3
        with:
          name: radar-campinas-kb
      
      - name: ğŸ”§ Make binary executable
        run: chmod +x radar-campinas-kb
      
      - name: ğŸ—„ï¸ Setup databases
        run: |
          # Aplicar migrations no target DB
          PGPASSWORD=${{ secrets.TARGET_DB_PASSWORD }} psql -h localhost -U postgres -d radar_campinas -f backend/internal/database/migrations/knowledge_base_schema.sql
          
          # Setup source DB com dados de exemplo (se necessÃ¡rio)
          # PGPASSWORD=${{ secrets.SOURCE_DB_PASSWORD }} psql -h localhost -p 5433 -U postgres -d source_db -f scripts/setup_source_db.sql || true
      
      - name: ğŸš€ Run Knowledge Base Generation
        env:
          SOURCE_DSN: "postgres://postgres:${{ secrets.SOURCE_DB_PASSWORD }}@localhost:5433/source_db?sslmode=disable"
          TARGET_DSN: "postgres://postgres:${{ secrets.TARGET_DB_PASSWORD }}@localhost:5432/radar_campinas?sslmode=disable"
          CELL_RESOLUTION: ${{ github.event.inputs.cell_resolution || '500' }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '365' }}
        run: |
          echo "ğŸ”® Iniciando geraÃ§Ã£o da base de conhecimento..."
          echo "ğŸ“Š ParÃ¢metros:"
          echo "   â€¢ ResoluÃ§Ã£o: ${CELL_RESOLUTION}m"
          echo "   â€¢ PerÃ­odo: Ãºltimos ${DAYS_BACK} dias"
          
          # TODO: Executar o binÃ¡rio com os parÃ¢metros corretos
          # ./radar-campinas-kb generate-kb --cell-resolution=${CELL_RESOLUTION} --days-back=${DAYS_BACK}
          echo "âœ… GeraÃ§Ã£o concluÃ­da (placeholder)"
      
      - name: ğŸ“Š Generate quality report
        run: |
          echo "ğŸ“Š Gerando relatÃ³rio de qualidade..."
          # Extrair mÃ©tricas do banco
          # PGPASSWORD=${{ secrets.TARGET_DB_PASSWORD }} psql -h localhost -U postgres -d radar_campinas -c "SELECT * FROM analytics.quality_reports ORDER BY report_date DESC LIMIT 1"

  # ============================================================================
  # STAGE 6: NOTIFY
  # ============================================================================
  
  notify-success:
    name: ğŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: generate-knowledge-base
    if: success()
    steps:
      - name: ğŸ“¢ Send success notification
        run: |
          echo "âœ… Pipeline executado com sucesso!"
          echo "ğŸ“Š Base de conhecimento gerada com sucesso"
          # Adicionar notificaÃ§Ã£o Slack/Discord/Email aqui

  notify-failure:
    name: ğŸš¨ Notify Failure
    runs-on: ubuntu-latest
    needs: [lint-go, validate-sql, build-app, unit-tests, test-migrations]
    if: failure()
    steps:
      - name: ğŸš¨ Send failure notification
        run: |
          echo "âŒ Pipeline falhou!"
          echo "ğŸ” Verifique os logs para mais detalhes"
          # Adicionar notificaÃ§Ã£o Slack/Discord/Email aqui
